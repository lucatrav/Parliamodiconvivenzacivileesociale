<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parliamo di Convivenza Civile e Sociale</title>
    <link href="../css/index.css" rel="stylesheet">
</head>
<body>
<div class="preload-hint" id="preloadHint">Precaricando contenuti...</div>

<h1 class="titolo">Parliamo di Convivenza Civile e Sociale</h1>

<!-- Container per i loghi con gestione errori -->
<div class="logo-container">
    <img src="../images/logo ministero del lavoro e delle politiche sociali.jpg"
         alt="Logo Ministero del Lavoro e delle Politiche Sociali"
         loading="lazy"
         onerror="this.parentElement.innerHTML='<div class=\'image-error\'>Logo Ministero<br>Immagine non trovata</div>'">

    <img src="../images/carcere-torino.jpg"
         alt="Foto Carcere Torino"
         loading="lazy"
         onerror="this.parentElement.innerHTML='<div class=\'image-error\'>Carcere Torino<br>Immagine non trovata</div>'">

    <img src="../images/logo-regione-puglia.png"
         alt="Logo Regione Puglia"
         loading="lazy"
         onerror="this.parentElement.innerHTML='<div class=\'image-error\'>Logo Regione Puglia<br>Immagine non trovata</div>'">
</div>

<div class="box1">
    <img src="../images/logo SinP.jpg"
         alt="Foto Logo SinP"
         height="200"
         width="200"
         loading="lazy"
         onerror="this.parentElement.innerHTML='<div class=\'image-error\'>Logo SinP<br>Immagine non trovata</div>'">
</div>

<table>
    <tr>
        <th>Dati Statistici Fase Iniziale</th>
        <th>Dati Statistici Fase Finale</th>
    </tr>
    <tr>
        <td><a href="dashboard.html?anno=2017&fase=iniziale" data-preload="2017,iniziale">Anno 2017-2018</a></td>
        <td><a href="dashboard.html?anno=2017&fase=finale" data-preload="2017,finale">Anno 2017-2018</a></td>
    </tr>
    <tr>
        <td><a href="dashboard.html?anno=2018&fase=iniziale" data-preload="2018,iniziale">Anno 2018-2019</a></td>
        <td><a href="dashboard.html?anno=2018&fase=finale" data-preload="2018,finale">Anno 2018-2019</a></td>
    </tr>
    <tr>
        <td><a href="dashboard.html?anno=2019&fase=iniziale" data-preload="2019,iniziale">Anno 2019-2020</a></td>
        <td><a href="dashboard.html?anno=2019&fase=finale" data-preload="2019,finale">Anno 2019-2020</a></td>
    </tr>
    <tr>
        <td><a href="dashboard.html?anno=2021&fase=iniziale" data-preload="2021,iniziale">Anno 2021-2022</a></td>
        <td><a href="dashboard.html?anno=2021&fase=finale" data-preload="2021,finale">Anno 2021-2022</a></td>
    </tr>
    <tr>
        <td><a href="dashboard.html?anno=2022&fase=iniziale" data-preload="2022,iniziale">Anno 2022-2023</a></td>
        <td><a href="dashboard.html?anno=2022&fase=finale" data-preload="2022,finale">Anno 2022-2023</a></td>
    </tr>
    <tr>
        <td><a href="dashboard.html?anno=2023&fase=iniziale" data-preload="2023,iniziale">Anno 2023-2024</a></td>
        <td><a href="dashboard.html?anno=2023&fase=finale" data-preload="2023,finale">Anno 2023-2024</a></td>
    </tr>
    <tr>
        <td><a href="dashboard.html?anno=2024&fase=iniziale" data-preload="2024,iniziale">Anno 2024-2025</a></td>
        <td><a href="dashboard.html?anno=2024&fase=finale" data-preload="2024,finale">Anno 2024-2025</a></td>
    </tr>
</table>

<table>
    <tr>
        <th>Relazioni Studenti</th>
        <th>Relazioni Detenuti</th>
    </tr>
    <tr>
        <td><a href="pagina.html?anno=2017&relazioni=studenti" data-preload="2017,studenti">Anno 2017-2018</a></td>
        <td><a href="pagina.html?anno=2017&relazioni=detenuti" data-preload="2017,detenuti">Anno 2017-2018</a></td>
    </tr>
    <tr>
        <td><a href="pagina.html?anno=2018&relazioni=studenti" data-preload="2018,studenti">Anno 2018-2019</a></td>
        <td><a href="pagina.html?anno=2018&relazioni=detenuti" data-preload="2018,detenuti">Anno 2018-2019</a></td>
    </tr>
    <tr>
        <td><a href="pagina.html?anno=2019&relazioni=studenti" data-preload="2019,studenti">Anno 2019-2020</a></td>
        <td><a href="pagina.html?anno=2019&relazioni=detenuti" data-preload="2019,detenuti">Anno 2019-2020</a></td>
    </tr>
    <tr>
        <td><a href="pagina.html?anno=2020&relazioni=studenti" data-preload="2020,studenti">Anno 2020-2021</a></td>
        <td><a href="pagina.html?anno=2020&relazioni=detenuti" data-preload="2020,detenuti">Anno 2020-2021</a></td>
    </tr>
    <tr>
        <td><a href="pagina.html?anno=2021&relazioni=studenti" data-preload="2021,studenti">Anno 2021-2022</a></td>
        <td><a href="pagina.html?anno=2021&relazioni=detenuti" data-preload="2021,detenuti">Anno 2021-2022</a></td>
    </tr>
    <tr>
        <td><a href="pagina.html?anno=2022&relazioni=studenti" data-preload="2022,studenti">Anno 2022-2023</a></td>
        <td><a href="pagina.html?anno=2022&relazioni=detenuti" data-preload="2022,detenuti">Anno 2022-2023</a></td>
    </tr>
    <tr>
        <td><a href="pagina.html?anno=2023&relazioni=studenti" data-preload="2023,studenti">Anno 2023-2024</a></td>
        <td><a href="pagina.html?anno=2023&relazioni=detenuti" data-preload="2023,detenuti">Anno 2023-2024</a></td>
    </tr>
    <tr>
        <td><a href="pagina.html?anno=2024&relazioni=studenti" data-preload="2024,studenti">Anno 2024-2025</a></td>
        <td><a href="pagina.html?anno=2024&relazioni=detenuti" data-preload="2024,detenuti">Anno 2024-2025</a></td>
    </tr>
</table>

<script>
    // Debug: Verifica i percorsi delle immagini
    function debugImagePaths() {
        const images = document.querySelectorAll('img[src^="images/"]');
        console.log('=== DEBUG IMMAGINI ===');
        console.log('URL corrente:', window.location.href);
        console.log('Percorso base:', window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1));

        images.forEach((img, index) => {
            const fullPath = new URL(img.src, window.location.href).href;
            console.log(`Immagine ${index + 1}:`);
            console.log('  Src:', img.src);
            console.log('  Percorso completo:', fullPath);
            console.log('  Alt:', img.alt);
            console.log('---');
        });
    }

    // Gestore errori immagini con debug
    function handleImageError(img) {
        console.error(`Errore caricamento immagine: ${img.src}`);
        console.error(`Percorso completo tentato: ${new URL(img.src, window.location.href).href}`);

        // Crea elemento di errore
        const errorDiv = document.createElement('div');
        errorDiv.className = 'image-error';
        errorDiv.innerHTML = `
                <strong>${img.alt || 'Immagine'}</strong><br>
                Non trovata<br>
                <small>Percorso: ${img.src}</small>
            `;

        // Sostituisci l'immagine con il messaggio di errore
        img.parentNode.replaceChild(errorDiv, img);
    }

    // Preload intelligente per i link
    function setupPreload() {
        const preloadHint = document.getElementById('preloadHint');
        const links = document.querySelectorAll('a[data-preload]');

        links.forEach(link => {
            let preloadTimeout;

            link.addEventListener('mouseenter', () => {
                preloadTimeout = setTimeout(() => {
                    const [anno, tipo] = link.dataset.preload.split(',');
                    preloadSection(anno, tipo);
                    preloadHint.style.display = 'block';
                    preloadHint.textContent = `Precaricando ${anno} - ${tipo}...`;

                    setTimeout(() => {
                        preloadHint.style.display = 'none';
                    }, 2000);
                }, 500); // Preload dopo 500ms di hover
            });

            link.addEventListener('mouseleave', () => {
                clearTimeout(preloadTimeout);
            });
        });
    }

    // Funzione di preload per una sezione specifica
    async function preloadSection(anno, tipo) {
        try {
            // Prova a precaricare le prime 3 immagini di una sezione
            const imagesToPreload = [
                `grafici/${anno}/${anno}-${tipo}-1-1.png`,
                `grafici/${anno}/${anno}-${tipo}-1-2.png`,
                `grafici/${anno}/${anno}-${tipo}-2-1.png`
            ];

            const preloadPromises = imagesToPreload.map(src => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = img.onerror = () => resolve();
                    img.src = src;
                });
            });

            await Promise.all(preloadPromises);
            console.log(`Preload completato per ${anno}-${tipo}`);

        } catch (error) {
            console.warn(`Errore durante il preload di ${anno}-${tipo}:`, error);
        }
    }

    // Test automatico dei percorsi immagini
    function testImagePaths() {
        const testImages = [
            'images/logo ministero del lavoro e delle politiche sociali.jpg',
            'images/carcere-torino.jpg',
            'images/logo-regione-puglia.png',
            'images/logo SinP.jpg'
        ];

        console.log('=== TEST PERCORSI IMMAGINI ===');

        testImages.forEach(async (imagePath, index) => {
            try {
                const response = await fetch(imagePath, { method: 'HEAD' });
                console.log(`âœ… ${imagePath}: ${response.status} ${response.statusText}`);
            } catch (error) {
                console.log(`âŒ ${imagePath}: Errore - ${error.message}`);

                // Prova percorsi alternativi
                const alternatives = [
                    `./${imagePath}`,
                    `/${imagePath}`,
                    imagePath.replace('images/', './images/'),
                    imagePath.replace('images/', '../images/')
                ];

                for (const alt of alternatives) {
                    try {
                        const altResponse = await fetch(alt, { method: 'HEAD' });
                        if (altResponse.ok) {
                            console.log(`âœ… Alternativa funzionante: ${alt}`);
                            break;
                        }
                    } catch (e) {
                        console.log(`âŒ Alternativa ${alt}: ${e.message}`);
                    }
                }
            }
        });
    }

    // Funzione per verificare la struttura delle cartelle
    async function checkFolderStructure() {
        console.log('=== VERIFICA STRUTTURA CARTELLE ===');

        const foldersToCheck = ['images/', 'css/', 'grafici/'];

        for (const folder of foldersToCheck) {
            try {
                const response = await fetch(folder);
                console.log(`ðŸ“ ${folder}: ${response.status} ${response.statusText}`);
            } catch (error) {
                console.log(`ðŸ“ ${folder}: Non accessibile - ${error.message}`);
            }
        }
    }

    // Inizializzazione
    document.addEventListener('DOMContentLoaded', () => {
        console.log('ðŸ”§ Debug mode attivo');

        // Esegui debug
        debugImagePaths();
        testImagePaths();
        checkFolderStructure();

        // Setup preload
        setupPreload();

        // Aggiungi gestori di errore a tutte le immagini
        const images = document.querySelectorAll('img');
        images.forEach(img => {
            if (!img.onerror) {
                img.onerror = () => handleImageError(img);
            }
        });

        // Mostra informazioni di debug nella console
        setTimeout(() => {
            console.log('=== INFORMAZIONI UTILI ===');
            console.log('Se le immagini non si caricano, verifica:');
            console.log('1. Che la cartella "images" sia nella stessa directory di index.html');
            console.log('2. Che i nomi dei file corrispondano esattamente (maiuscole/minuscole)');
            console.log('3. Che i file esistano realmente');
            console.log('4. I permessi di accesso alle cartelle');
            console.log('Apri la console di sviluppo per vedere i dettagli degli errori');
        }, 1000);
    });

    // Esponi funzioni per debug manuale
    window.debugQuestionario = {
        testPaths: testImagePaths,
        checkStructure: checkFolderStructure,
        debugImages: debugImagePaths
    };
</script>
</body>
</html>