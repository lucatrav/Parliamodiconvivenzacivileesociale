<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dettagli Questionario</title>
    <link href="css/pagina.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
</head>
<body>
<div class="main-container">
    <h2 id="titoloAnno"></h2>

    <div class="custom-slider" id="graficiContainer">
        <div class="loading-indicator">
            <div class="spinner"></div>
            Caricamento grafici...
            <div class="loading-progress" id="loadingProgress">0%</div>
        </div>

        <div class="slides-container" id="slidesContainer">
            <!-- Le slide verranno inserite qui -->
        </div>

        <button class="nav-button nav-prev" id="prevBtn">‹</button>
        <button class="nav-button nav-next" id="nextBtn">›</button>

        <div class="slide-counter" id="slideCounter">1 / 1</div>
        <div class="indicators" id="indicators"></div>
    </div>

    <div id="categoryNav"></div>
    <button class="back-button" onClick="tornaIndietro()">Torna alla pagina precedente</button>
</div>

<script>
    class CustomSlider {
        constructor(container) {
            this.container = container;
            this.slidesContainer = container.querySelector('#slidesContainer');
            this.prevBtn = container.querySelector('#prevBtn');
            this.nextBtn = container.querySelector('#nextBtn');
            this.slideCounter = container.querySelector('#slideCounter');
            this.indicators = container.querySelector('#indicators');
            this.loadingIndicator = container.querySelector('.loading-indicator');
            this.loadingProgress = container.querySelector('#loadingProgress');

            this.slides = [];
            this.currentSlide = 0;
            this.totalSlides = 0;

            this.initEvents();
        }

        initEvents() {
            this.prevBtn.addEventListener('click', () => this.prevSlide());
            this.nextBtn.addEventListener('click', () => this.nextSlide());

            // Supporto touch per mobile
            let startX = 0;
            let endX = 0;

            this.slidesContainer.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
            });

            this.slidesContainer.addEventListener('touchend', (e) => {
                endX = e.changedTouches[0].clientX;
                const diff = startX - endX;

                if (Math.abs(diff) > 50) {
                    if (diff > 0) {
                        this.nextSlide();
                    } else {
                        this.prevSlide();
                    }
                }
            });

            // Supporto keyboard
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') this.prevSlide();
                if (e.key === 'ArrowRight') this.nextSlide();
            });
        }

        addSlide(imgElement, slideIndex, isFirst = false) {
            const slide = document.createElement('div');
            slide.classList.add('slide');
            slide.appendChild(imgElement);

            this.slidesContainer.appendChild(slide);
            this.slides.push(slide);
            this.totalSlides++;

            // Se è la prima slide, rendila attiva
            if (isFirst) {
                slide.classList.add('active');
                this.hideLoading();
            }

            this.updateIndicators();
            this.updateCounter();
            this.updateNavButtons();
        }

        updateProgress(loaded, total) {
            if (this.loadingProgress && total > 0) {
                const percentage = Math.round((loaded / total) * 100);
                this.loadingProgress.textContent = `${percentage}% (${loaded}/${total})`;
            }
        }

        goToSlide(index) {
            if (index < 0 || index >= this.totalSlides) return;

            // Rimuovi classe active dalla slide corrente
            this.slides[this.currentSlide].classList.remove('active');

            // Imposta nuova slide corrente
            this.currentSlide = index;
            this.slides[this.currentSlide].classList.add('active');

            // Forza il repaint dell'immagine
            setTimeout(() => {
                const img = this.slides[this.currentSlide].querySelector('.grafico-img');
                if (img) {
                    img.style.transform = 'translateZ(0)';
                    // Trigger reflow
                    img.offsetHeight;
                }
            }, 50);

            this.updateIndicators();
            this.updateCounter();
            this.updateNavButtons();
        }

        nextSlide() {
            const nextIndex = (this.currentSlide + 1) % this.totalSlides;
            this.goToSlide(nextIndex);
        }

        prevSlide() {
            const prevIndex = (this.currentSlide - 1 + this.totalSlides) % this.totalSlides;
            this.goToSlide(prevIndex);
        }

        updateIndicators() {
            this.indicators.innerHTML = '';

            for (let i = 0; i < this.totalSlides; i++) {
                const indicator = document.createElement('div');
                indicator.classList.add('indicator');
                if (i === this.currentSlide) {
                    indicator.classList.add('active');
                }
                indicator.addEventListener('click', () => this.goToSlide(i));
                this.indicators.appendChild(indicator);
            }
        }

        updateCounter() {
            this.slideCounter.textContent = `${this.currentSlide + 1} / ${this.totalSlides}`;
        }

        updateNavButtons() {
            this.prevBtn.disabled = this.totalSlides <= 1;
            this.nextBtn.disabled = this.totalSlides <= 1;
        }

        hideLoading() {
            if (this.loadingIndicator) {
                this.loadingIndicator.style.display = 'none';
            }
        }
    }

    // Inizializzazione
    const params = new URLSearchParams(window.location.search);
    const anno = params.get('anno');
    const fase = params.get('fase');
    const relazioni = params.get('relazioni');
    const tipo = fase ? fase : relazioni;

    const titoloAnno = document.getElementById('titoloAnno');
    if (fase) {
        titoloAnno.textContent = `Dati Statistici per ${anno} - ${fase}`;
    } else if (relazioni) {
        titoloAnno.textContent = `Relazioni ${relazioni} per ${anno}`;
    } else {
        titoloAnno.textContent = `Grafici per ${anno}`;
    }

    const graficiContainer = document.getElementById('graficiContainer');
    const categoryNav = document.getElementById('categoryNav');

    const slider = new CustomSlider(graficiContainer);
    let nomiScuole = {};
    let categorieInfo = [];

    // Funzione per scoprire tutte le immagini disponibili
    async function scopriImmaginiDisponibili() {
        const immaginiTrovate = [];
        let categoria = 1;

        while (true) {
            let sottoIndice = 1;
            let trovatoAlmenoUno = false;

            while (true) {
                const fileBase = `${anno}-${tipo}-${categoria}-${sottoIndice}`;
                const imgSrc = `grafici/${anno}/${fileBase}.png`;

                try {
                    // Verifica se l'immagine esiste facendo una HEAD request
                    const response = await fetch(imgSrc, { method: 'HEAD' });
                    if (response.ok) {
                        immaginiTrovate.push({
                            src: imgSrc,
                            categoria: categoria,
                            sottoIndice: sottoIndice,
                            fileBase: fileBase
                        });
                        trovatoAlmenoUno = true;
                        sottoIndice++;
                    } else {
                        break; // Non esistono più immagini per questa categoria
                    }
                } catch (error) {
                    break; // Errore o immagine non trovata
                }
            }

            if (!trovatoAlmenoUno) {
                break; // Non esistono più categorie
            }
            categoria++;
        }

        return immaginiTrovate;
    }

    // Funzione per il preload delle immagini con concorrenza limitata
    async function preloadImmagini(immaginiInfo, maxConcorrenti = 5) {
        const risultati = [];
        let completate = 0;

        // Funzione per caricare una singola immagine
        const caricaSingolaImmagine = (info) => {
            return new Promise((resolve, reject) => {
                const img = new Image();

                img.onload = () => {
                    completate++;
                    slider.updateProgress(completate, immaginiInfo.length);
                    resolve({ ...info, img });
                };

                img.onerror = () => {
                    completate++;
                    slider.updateProgress(completate, immaginiInfo.length);
                    reject(new Error(`Errore caricamento: ${info.src}`));
                };

                img.src = info.src;
            });
        };

        // Carica le immagini in lotti per evitare di sovraccaricare il browser
        for (let i = 0; i < immaginiInfo.length; i += maxConcorrenti) {
            const lotto = immaginiInfo.slice(i, i + maxConcorrenti);
            const promesseLotto = lotto.map(caricaSingolaImmagine);

            try {
                const risultatiLotto = await Promise.allSettled(promesseLotto);
                risultatiLotto.forEach((risultato, index) => {
                    if (risultato.status === 'fulfilled') {
                        risultati.push(risultato.value);
                    } else {
                        console.warn(`Errore caricamento immagine ${lotto[index].src}:`, risultato.reason);
                    }
                });
            } catch (error) {
                console.error('Errore nel caricamento del lotto:', error);
            }
        }

        return risultati;
    }

    async function caricaGrafici() {
        try {
            // Carica i nomi delle scuole
            try {
                const response = await fetch(`grafici/${anno}/nomiScuole.json`);
                nomiScuole = await response.json();
            } catch (err) {
                console.warn("Non è stato possibile caricare nomiScuole.json", err);
            }

            // Scopri tutte le immagini disponibili
            console.log('Ricerca immagini disponibili...');
            const immaginiInfo = await scopriImmaginiDisponibili();

            if (immaginiInfo.length === 0) {
                slider.hideLoading();
                graficiContainer.innerHTML = '<div class="no-graphics-message">Nessun grafico trovato per questa combinazione.</div>';
                return;
            }

            console.log(`Trovate ${immaginiInfo.length} immagini. Inizio preload...`);

            // Preload tutte le immagini
            const immaginiCaricate = await preloadImmagini(immaginiInfo, 6); // Carica max 6 alla volta

            console.log(`Caricate ${immaginiCaricate.length} immagini su ${immaginiInfo.length}`);

            // Ordina le immagini per categoria e sottocategoria
            immaginiCaricate.sort((a, b) => {
                if (a.categoria !== b.categoria) {
                    return a.categoria - b.categoria;
                }
                return a.sottoIndice - b.sottoIndice;
            });

            // Aggiungi le immagini al slider
            immaginiCaricate.forEach((imgInfo, index) => {
                const displayImg = document.createElement('img');
                displayImg.src = imgInfo.img.src;
                displayImg.alt = `Grafico ${imgInfo.categoria}-${imgInfo.sottoIndice} per ${anno} - ${tipo}`;
                displayImg.classList.add('grafico-img');

                // Aggiungi al slider
                slider.addSlide(displayImg, index, index === 0);

                // Salva info categoria per il primo grafico di ogni categoria
                if (imgInfo.sottoIndice === 1) {
                    const chiave = `${anno}-${tipo}-${imgInfo.categoria}-1`;
                    const nome = nomiScuole[chiave] || `Questionario ${imgInfo.categoria}`;
                    categorieInfo.push({
                        nome: nome,
                        slideIndex: index
                    });
                }
            });

            // Crea i bottoni delle categorie
            createCategoryButtons();

            console.log('Caricamento completato!');

        } catch (error) {
            console.error('Errore durante il caricamento:', error);
            slider.hideLoading();
            graficiContainer.innerHTML = '<div class="no-graphics-message">Errore durante il caricamento dei grafici.</div>';
        }
    }

    function createCategoryButtons() {
        categorieInfo.forEach((categoria) => {
            const button = document.createElement('button');
            button.textContent = categoria.nome;
            button.onclick = () => {
                slider.goToSlide(categoria.slideIndex);
            };
            categoryNav.appendChild(button);
        });
    }

    function tornaIndietro() {
        window.history.back();
    }

    // Avvia il caricamento
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', caricaGrafici);
    } else {
        caricaGrafici();
    }
</script>
</body>
</html>