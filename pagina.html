<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dettagli Questionario</title>
    <link href="css/pagina.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
</head>
<body>
<div class="main-container">
    <h2 id="titoloAnno"></h2>

    <div class="custom-slider" id="graficiContainer">
        <div class="loading-indicator">
            <div class="spinner"></div>
            Caricamento grafici...
        </div>

        <div class="slides-container" id="slidesContainer">
            <!-- Le slide verranno inserite qui -->
        </div>

        <button class="nav-button nav-prev" id="prevBtn">‹</button>
        <button class="nav-button nav-next" id="nextBtn">›</button>

        <div class="slide-counter" id="slideCounter">1 / 1</div>
        <div class="indicators" id="indicators"></div>
    </div>

    <div id="categoryNav"></div>
    <button class="back-button" onClick="tornaIndietro()">Torna alla pagina precedente</button>
</div>

<script>
    class CustomSlider {
        constructor(container) {
            this.container = container;
            this.slidesContainer = container.querySelector('#slidesContainer');
            this.prevBtn = container.querySelector('#prevBtn');
            this.nextBtn = container.querySelector('#nextBtn');
            this.slideCounter = container.querySelector('#slideCounter');
            this.indicators = container.querySelector('#indicators');
            this.loadingIndicator = container.querySelector('.loading-indicator');

            this.slides = [];
            this.currentSlide = 0;
            this.totalSlides = 0;

            this.initEvents();
        }

        initEvents() {
            this.prevBtn.addEventListener('click', () => this.prevSlide());
            this.nextBtn.addEventListener('click', () => this.nextSlide());

            // Supporto touch per mobile
            let startX = 0;
            let endX = 0;

            this.slidesContainer.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
            });

            this.slidesContainer.addEventListener('touchend', (e) => {
                endX = e.changedTouches[0].clientX;
                const diff = startX - endX;

                if (Math.abs(diff) > 50) {
                    if (diff > 0) {
                        this.nextSlide();
                    } else {
                        this.prevSlide();
                    }
                }
            });

            // Supporto keyboard
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') this.prevSlide();
                if (e.key === 'ArrowRight') this.nextSlide();
            });
        }

        addSlide(imgElement, slideIndex) {
            const slide = document.createElement('div');
            slide.classList.add('slide');
            slide.appendChild(imgElement);

            this.slidesContainer.appendChild(slide);
            this.slides.push(slide);
            this.totalSlides++;

            // Se è la prima slide, rendila attiva
            if (this.totalSlides === 1) {
                slide.classList.add('active');
                this.hideLoading();
            }

            this.updateIndicators();
            this.updateCounter();
            this.updateNavButtons();
        }

        goToSlide(index) {
            if (index < 0 || index >= this.totalSlides) return;

            // Rimuovi classe active dalla slide corrente
            this.slides[this.currentSlide].classList.remove('active');

            // Imposta nuova slide corrente
            this.currentSlide = index;
            this.slides[this.currentSlide].classList.add('active');

            // Forza il repaint dell'immagine
            setTimeout(() => {
                const img = this.slides[this.currentSlide].querySelector('.grafico-img');
                if (img) {
                    img.style.transform = 'translateZ(0)';
                    // Trigger reflow
                    img.offsetHeight;
                }
            }, 50);

            this.updateIndicators();
            this.updateCounter();
            this.updateNavButtons();
        }

        nextSlide() {
            const nextIndex = (this.currentSlide + 1) % this.totalSlides;
            this.goToSlide(nextIndex);
        }

        prevSlide() {
            const prevIndex = (this.currentSlide - 1 + this.totalSlides) % this.totalSlides;
            this.goToSlide(prevIndex);
        }

        updateIndicators() {
            this.indicators.innerHTML = '';

            for (let i = 0; i < this.totalSlides; i++) {
                const indicator = document.createElement('div');
                indicator.classList.add('indicator');
                if (i === this.currentSlide) {
                    indicator.classList.add('active');
                }
                indicator.addEventListener('click', () => this.goToSlide(i));
                this.indicators.appendChild(indicator);
            }
        }

        updateCounter() {
            this.slideCounter.textContent = `${this.currentSlide + 1} / ${this.totalSlides}`;
        }

        updateNavButtons() {
            this.prevBtn.disabled = this.totalSlides <= 1;
            this.nextBtn.disabled = this.totalSlides <= 1;
        }

        hideLoading() {
            if (this.loadingIndicator) {
                this.loadingIndicator.style.display = 'none';
            }
        }
    }

    // Inizializzazione
    const params = new URLSearchParams(window.location.search);
    const anno = params.get('anno');
    const fase = params.get('fase');
    const relazioni = params.get('relazioni');
    const tipo = fase ? fase : relazioni;

    const titoloAnno = document.getElementById('titoloAnno');
    if (fase) {
        titoloAnno.textContent = `Dati Statistici per ${anno} - ${fase}`;
    } else if (relazioni) {
        titoloAnno.textContent = `Relazioni ${relazioni} per ${anno}`;
    } else {
        titoloAnno.textContent = `Grafici per ${anno}`;
    }

    const graficiContainer = document.getElementById('graficiContainer');
    const categoryNav = document.getElementById('categoryNav');

    const slider = new CustomSlider(graficiContainer);
    let nomiScuole = {};
    let categorieInfo = [];

    async function caricaGrafici() {
        try {
            const response = await fetch(`grafici/${anno}/nomiScuole.json`);
            nomiScuole = await response.json();
        } catch (err) {
            console.warn("Non è stato possibile caricare nomiScuole.json", err);
        }

        let categoria = 1;
        let sottoIndice = 1;
        let trovatiGrafici = false;
        let slideIndex = 0;

        const caricaProssimaImmagine = async () => {
            const fileBase = `${anno}-${tipo}-${categoria}-${sottoIndice}`;
            const imgSrc = `grafici/${anno}/${fileBase}.png`;

            try {
                // Carica l'immagine completamente prima di mostrarla
                const img = await loadImage(imgSrc);

                trovatiGrafici = true;

                const displayImg = document.createElement('img');
                displayImg.src = img.src;
                displayImg.alt = `Grafico ${categoria}-${sottoIndice} per ${anno} - ${tipo}`;
                displayImg.classList.add('grafico-img');

                // Aggiungi al slider
                slider.addSlide(displayImg, slideIndex);

                // Salva info categoria
                if (sottoIndice === 1) {
                    const chiave = `${anno}-${tipo}-${categoria}-1`;
                    const nome = nomiScuole[chiave] || `Questionario ${categoria}`;
                    categorieInfo.push({
                        nome: nome,
                        slideIndex: slideIndex
                    });
                }

                slideIndex++;
                sottoIndice++;

                // Carica la prossima immagine
                setTimeout(caricaProssimaImmagine, 100);

            } catch (error) {
                if (sottoIndice > 1) {
                    categoria++;
                    sottoIndice = 1;
                    setTimeout(caricaProssimaImmagine, 100);
                } else {
                    if (!trovatiGrafici) {
                        slider.hideLoading();
                        graficiContainer.innerHTML = '<div class="no-graphics-message">Nessun grafico trovato per questa combinazione.</div>';
                    } else {
                        createCategoryButtons();
                    }
                }
            }
        };

        caricaProssimaImmagine();
    }

    function loadImage(src) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = src;
        });
    }

    function createCategoryButtons() {
        categorieInfo.forEach((categoria) => {
            const button = document.createElement('button');
            button.textContent = categoria.nome;
            button.onclick = () => {
                slider.goToSlide(categoria.slideIndex);
            };
            categoryNav.appendChild(button);
        });
    }

    function tornaIndietro() {
        window.history.back();
    }

    // Avvia il caricamento
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', caricaGrafici);
    } else {
        caricaGrafici();
    }
</script>
</body>
</html>